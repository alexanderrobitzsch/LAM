<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>(Restricted) Maximum Likelihood Estimation with Prior Distributions
and Penalty Functions under Multivariate Normality — mlnormal • LAM</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="(Restricted) Maximum Likelihood Estimation with Prior Distributions
and Penalty Functions under Multivariate Normality — mlnormal"><meta property="og:description" content="The mlnormal estimates statistical model for multivariate normally
distributed outcomes with specified mean structure and
covariance structure (see Details and Examples). Model classes include
multilevel models, factor analysis, structural equation models,
multilevel structural equation models, social relations model and
perhaps more.
The estimation can be conducted under maximum likelihood,
restricted maximum likelihood and
maximum posterior estimation with prior distribution.
Regularization (i.e. LASSO penalties) is also accomodated."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">LAM</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.8</span
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/alexanderrobitzsch/LAM/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>(Restricted) Maximum Likelihood Estimation with Prior Distributions
and Penalty Functions under Multivariate Normality</h1>
    
    <div class="hidden name"><code>mlnormal.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>The <code>mlnormal</code> estimates statistical model for multivariate normally
distributed outcomes with specified mean structure and
covariance structure (see Details and Examples). Model classes include
multilevel models, factor analysis, structural equation models,
multilevel structural equation models, social relations model and
perhaps more.</p>
<p>The estimation can be conducted under maximum likelihood,
restricted maximum likelihood and
maximum posterior estimation with prior distribution.
Regularization (i.e. LASSO penalties) is also accomodated.</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">mlnormal</span><span class="op">(</span><span class="va">y</span>, <span class="va">X</span>, <span class="va">id</span>, <span class="va">Z_list</span>, <span class="va">Z_index</span>, beta<span class="op">=</span><span class="cn">NULL</span>, <span class="va">theta</span>, method<span class="op">=</span><span class="st">"ML"</span>, prior<span class="op">=</span><span class="cn">NULL</span>,</span>
<span>    lambda_beta<span class="op">=</span><span class="cn">NULL</span>, weights_beta<span class="op">=</span><span class="cn">NULL</span>, lambda_theta<span class="op">=</span><span class="cn">NULL</span>, weights_theta<span class="op">=</span><span class="cn">NULL</span>,</span>
<span>    beta_lower<span class="op">=</span><span class="cn">NULL</span>, beta_upper<span class="op">=</span><span class="cn">NULL</span>,    theta_lower<span class="op">=</span><span class="cn">NULL</span>, theta_upper<span class="op">=</span><span class="cn">NULL</span>,</span>
<span>    maxit<span class="op">=</span><span class="fl">800</span>, globconv<span class="op">=</span><span class="fl">1e-05</span>, conv<span class="op">=</span><span class="fl">1e-06</span>, verbose<span class="op">=</span><span class="cn">TRUE</span>, REML_shortcut<span class="op">=</span><span class="cn">NULL</span>,</span>
<span>    use_ginverse<span class="op">=</span><span class="cn">FALSE</span>, vcov<span class="op">=</span><span class="cn">TRUE</span>, variance_shortcut<span class="op">=</span><span class="cn">TRUE</span>, use_Rcpp<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>    level<span class="op">=</span><span class="fl">0.95</span>, numdiff.parm<span class="op">=</span><span class="fl">1e-04</span>, control_beta<span class="op">=</span><span class="cn">NULL</span>, control_theta<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for mlnormal</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">object</span>, digits<span class="op">=</span><span class="fl">4</span>, file<span class="op">=</span><span class="cn">NULL</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for mlnormal</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">x</span>, digits<span class="op">=</span><span class="fl">4</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for mlnormal</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">object</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for mlnormal</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/logLik.html" class="external-link">logLik</a></span><span class="op">(</span><span class="va">object</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for mlnormal</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/vcov.html" class="external-link">vcov</a></span><span class="op">(</span><span class="va">object</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for mlnormal</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/confint.html" class="external-link">confint</a></span><span class="op">(</span><span class="va">object</span>, <span class="va">parm</span>, level<span class="op">=</span><span class="fl">.95</span>, <span class="va">...</span> <span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>
    <dl><dt>y</dt>
<dd><p>Vector of outcomes</p></dd>

  <dt>X</dt>
<dd><p>Matrix of covariates</p></dd>

  <dt>id</dt>
<dd><p>Vector of identifiers (subjects or clusters, see Details)</p></dd>

  <dt>Z_list</dt>
<dd><p>List of design matrices for covariance matrix (see Details)</p></dd>

  <dt>Z_index</dt>
<dd><p>Array containing loadings of design matrices (see Details).
The dimensions are units \(\times\) matrices \(\times\) parameters.</p></dd>

  <dt>beta</dt>
<dd><p>Initial vector for \(\bold{\beta}\)</p></dd>

  <dt>theta</dt>
<dd><p>Initial vector for \(\bold{\theta}\)</p></dd>

  <dt>method</dt>
<dd><p>Estimation method. Can be either <code>"ML"</code> or <code>"REML"</code>.</p></dd>

  <dt>prior</dt>
<dd><p>Prior distributions. Can be conveniently specified in a string
which is processed by the function <code>prior_model_parse</code>. Only
univariate prior distributions can be specified.</p></dd>

  <dt>lambda_beta</dt>
<dd><p>Parameter \(\lambda_{\bold{\beta}}\) for penalty function
  \(P( \bold{\beta} )=\lambda_{\bold{\beta}} \sum_h w_{\bold{\beta}h} | \beta _h |\)</p></dd>

  <dt>weights_beta</dt>
<dd><p>Parameter vector \(\bold{w}_{\bold{\beta}}\) for penalty function
  \(P( \bold{\beta} )=\lambda_{\bold{\beta}} \sum_h w_{\bold{\beta}h} | \beta _h |\)</p></dd>

  <dt>lambda_theta</dt>
<dd><p>Parameter \(\lambda_{\bold{\theta}}\) for penalty function
  \(P( \bold{\theta} )=\lambda_{\bold{\theta}}
            \sum_h w_{\bold{\theta}h} | \theta _h | \)</p></dd>

  <dt>weights_theta</dt>
<dd><p>Parameter vector \(\bold{w}_{\bold{\theta}}\) for penalty function
  \(P( \bold{\theta} )=\lambda_{\bold{\theta}}
          \sum_h w_{\bold{\theta}h} | \theta _h | \)</p></dd>


<dt>beta_lower</dt>
<dd><p>Vector containing lower bounds for \(\bold{\beta}\) parameter</p></dd>

<dt>beta_upper</dt>
<dd><p>Vector containing upper bounds for \(\bold{\beta}\) parameter</p></dd>

<dt>theta_lower</dt>
<dd><p>Vector containing lower bounds for \(\bold{\theta}\) parameter</p></dd>

<dt>theta_upper</dt>
<dd><p>Vector containing upper bounds for \(\bold{\theta}\) parameter</p></dd>


  <dt>maxit</dt>
<dd><p>Maximum number of iterations</p></dd>

  <dt>globconv</dt>
<dd><p>Convergence criterion deviance</p></dd>

  <dt>conv</dt>
<dd><p>Maximum parameter change</p></dd>

  <dt>verbose</dt>
<dd><p>Print progress?</p></dd>

  <dt>REML_shortcut</dt>
<dd><p>Logical indicating whether computational shortcuts should be used for
REML estimation</p></dd>

  <dt>use_ginverse</dt>
<dd><p>Logical indicating whether a generalized inverse should be used</p></dd>

  <dt>vcov</dt>
<dd><p>Logical indicating whether a covariance matrix of
\(\bold{\theta}\) parameter estimates should be computed in
case of REML (which is computationally demanding)</p></dd>

  <dt>variance_shortcut</dt>
<dd><p>Logical indicating whether computational shortcuts for calculating
covariance matrices should be used</p></dd>

  <dt>use_Rcpp</dt>
<dd><p>Logical indicating whether the <span class="pkg">Rcpp</span> package should be used</p></dd>

  <dt>level</dt>
<dd><p>Confidence level</p></dd>

  <dt>numdiff.parm</dt>
<dd><p>Numerical differentiation parameter</p></dd>

  <dt>control_beta</dt>
<dd><p>List with control arguments for \(\bold{\beta}\) estimation. The default
is <br><code>list( maxiter=10, conv=1E-4, ridge=1E-6)</code>.</p></dd>

  <dt>control_theta</dt>
<dd><p>List with control arguments for \(\bold{\theta}\) estimation. The default
is <br><code>list( maxiter=10, conv=1E-4, ridge=1E-6)</code>.</p></dd>

<dt>object</dt>
<dd><p>Object of class <code>mlnormal</code></p></dd>

<dt>digits</dt>
<dd><p>Number of digits used for rounding</p></dd>

<dt>file</dt>
<dd><p>File name</p></dd>

<dt>parm</dt>
<dd><p>Parameter to be selected for <code>confint</code> method</p></dd>

<dt>...</dt>
<dd><p>Further arguments to be passed</p></dd>

<dt>x</dt>
<dd><p>Object of class <code>mlnormal</code></p></dd>

</dl></div>
    <div id="details">
    <h2>Details</h2>
    <p>The data consists of outcomes \(\bold{y}_i\) and covariates \(\bold{X}_i\)
for unit \(i\). The unit can be subjects, clusters (like schools)
or the full outcome vector. It is assumed that \(\bold{y}_i\) is normally
distributed as \(N( \bold{\mu}_i, \bold{V}_i )\) where the mean structure is
modelled as $$ \bold{\mu}_i=\bold{X}_i \bold{\beta} $$ and the covariance
structure \( \bold{V}_i\) depends on a parameter vector \(\bold{\theta}\).
More specifically, the covariance matrix \( \bold{V}_i\)  is modelled as
a sum of functions of the parameter \(\bold{\theta}\) and known design matrices
\(\bold{Z}_{im}\) for unit \(i\) (\(m=1,\ldots,M\)). The model is
$$\bold{V}_i=\sum_{m=1}^M \bold{Z}_{im} \gamma_{im}  \qquad \mathrm{with}
\qquad \gamma_{im}=\prod_{h=1}^H \theta_h^{q_{imh}} $$
where \(q_{imh}\) are non-negative known integers specified in
<code>Z_index</code> and \(\bold{Z}_{im}\) are design matrices specified
in <code>Z_list</code>.</p>
<p>The estimation follows Fisher scoring (Jiang, 2007; for applications see also
Longford, 1987; Lee, 1990; Gill &amp; Swartz, 2001) and the
regularization approach is as described in Lin, Pang and Jiang (2013)
(see also Krishnapuram, Carin, Figueiredo, &amp; Hartemink, 2005).</p>
    </div>
    <div id="value">
    <h2>Value</h2>
    

<p>List with entries</p>
<dl><dt>theta</dt>
<dd><p>Estimated \(\bold{\theta}\) parameter</p></dd>

  <dt>beta</dt>
<dd><p>Estimated \(\bold{\beta}\) parameter</p></dd>

  <dt>theta_summary</dt>
<dd><p>Summary of \(\bold{\theta}\) parameters</p></dd>

  <dt>beta_summary</dt>
<dd><p>Summary of \(\bold{\beta}\) parameters</p></dd>

  <dt>coef</dt>
<dd><p>Estimated parameters</p></dd>

  <dt>vcov</dt>
<dd><p>Covariance matrix of estimated parameters</p></dd>

  <dt>ic</dt>
<dd><p>Information criteria</p></dd>

  <dt>V_list</dt>
<dd><p>List with fitted covariance matrices \(\bold{V}_i\)</p></dd>

  <dt>V1_list</dt>
<dd><p>List with inverses of fitted covariance matrices \(\bold{V}_i\)</p></dd>

  <dt>prior_args</dt>
<dd><p>Some arguments in case of prior distributions</p></dd>

  <dt>...</dt>
<dd><p>More values</p></dd>

</dl></div>
    <div id="references">
    <h2>References</h2>
    <p>Gill, P. S., &amp; Swartz, T. B. (2001). Statistical analyses for round
robin interaction data.
<em>Canadian Journal of Statistics, 29</em>, 321-331.
<a href="https://doi.org/10.2307/3316080" class="external-link">doi:10.2307/3316080</a></p>
<p>Jiang, J. (2007). <em>Linear and generalized linear mixed models and their
applications</em>. New York: Springer.</p>
<p>Krishnapuram, B., Carin, L., Figueiredo, M. A., &amp; Hartemink, A. J. (2005).
Sparse multinomial logistic regression: Fast algorithms and generalization
bounds. <em>IEEE Transactions on Pattern Analysis and Machine Intelligence, 27</em>, 957-968.
<a href="https://doi.org/10.1109/TPAMI.2005.127" class="external-link">doi:10.1109/TPAMI.2005.127</a></p>
<p>Lee, S. Y. (1990). Multilevel analysis of structural equation models.
<em>Biometrika, 77</em>, 763-772.
<a href="https://doi.org/10.1093/biomet/77.4.763" class="external-link">doi:10.1093/biomet/77.4.763</a></p>
<p>Lin, B., Pang, Z., &amp; Jiang, J. (2013). Fixed and random effects selection
by REML and pathwise coordinate optimization.
<em>Journal of Computational and Graphical Statistics, 22</em>, 341-355.
<a href="https://doi.org/10.1080/10618600.2012.681219" class="external-link">doi:10.1080/10618600.2012.681219</a></p>
<p>Longford, N. T. (1987). A fast scoring algorithm for maximum likelihood
estimation in unbalanced mixed models with nested random effects.
<em>Biometrika, 74</em>, 817-827.
<a href="https://doi.org/10.1093/biomet/74.4.817" class="external-link">doi:10.1093/biomet/74.4.817</a></p>
    </div>
    <div id="see-also">
    <h2>See also</h2>
    <div class="dont-index"><p>See <span class="pkg">lavaan</span>, <span class="pkg">sem</span>, <span class="pkg">lava</span>, <span class="pkg">OpenMx</span> or <span class="pkg">nlsem</span>
packages for estimation of
(single level) structural equation models.</p>
<p>See the <span class="pkg">regsem</span>
and <span class="pkg">lsl</span> packages for regularized structural equation models.</p>
<p>See <span class="pkg">lme4</span> or <span class="pkg">nlme</span> package for estimation of multilevel
models.</p>
<p>See the <span class="pkg">lmmlasso</span> and <span class="pkg">glmmLasso</span> packages for regularized
mixed effects models.</p>
<p>See <span class="pkg">OpenMx</span> and <span class="pkg">xxM</span> packages (<em>http://xxm.times.uh.edu/</em>) for
estimation of multilevel structural equation models.</p></div>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span><span class="co">#############################################################################</span></span>
<span><span class="co"># EXAMPLE 1: Two-level random intercept model</span></span>
<span><span class="co">#############################################################################</span></span>
<span></span>
<span><span class="co">#--------------------------------------------------------------</span></span>
<span><span class="co"># Simulate data</span></span>
<span><span class="co">#--------------------------------------------------------------</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">976</span><span class="op">)</span></span>
<span><span class="va">G</span> <span class="op">&lt;-</span> <span class="fl">150</span> ; <span class="va">rg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">20</span><span class="op">)</span>   <span class="co"># 150 groups with group sizes ranging from 10 to 20</span></span>
<span><span class="co">#* simulate group sizes</span></span>
<span><span class="va">ng</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span> <span class="va">G</span>, min<span class="op">=</span><span class="va">rg</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, max<span class="op">=</span><span class="va">rg</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">)</span> <span class="op">)</span></span>
<span><span class="va">idcluster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">G</span>, <span class="va">ng</span> <span class="op">)</span></span>
<span><span class="co">#* simulate covariate</span></span>
<span><span class="va">iccx</span> <span class="op">&lt;-</span> <span class="fl">.3</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span> <span class="va">G</span>, sd<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span> <span class="va">iccx</span><span class="op">)</span> <span class="op">)</span>, <span class="va">ng</span> <span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">ng</span><span class="op">)</span>, sd<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">iccx</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="co">#* simulate outcome</span></span>
<span><span class="va">b0</span> <span class="op">&lt;-</span> <span class="fl">1.5</span> ; <span class="va">b1</span> <span class="op">&lt;-</span> <span class="fl">.4</span> ; <span class="va">iccy</span> <span class="op">&lt;-</span> <span class="fl">.2</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">b0</span> <span class="op">+</span> <span class="va">b1</span><span class="op">*</span><span class="va">x</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span> <span class="va">G</span>, sd<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span> <span class="va">iccy</span><span class="op">)</span> <span class="op">)</span>, <span class="va">ng</span> <span class="op">)</span> <span class="op">+</span></span>
<span>         <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">ng</span><span class="op">)</span>, sd<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">iccy</span><span class="op">)</span> <span class="op">)</span></span>
<span></span>
<span><span class="co">#-----------------------</span></span>
<span><span class="co">#--- arrange input for mlnormal function</span></span>
<span></span>
<span><span class="va">id</span> <span class="op">&lt;-</span> <span class="va">idcluster</span>          <span class="co"># cluster is identifier</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span> <span class="fl">1</span>, <span class="va">x</span> <span class="op">)</span>      <span class="co"># matrix of covariates</span></span>
<span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span>          <span class="co"># number of units (clusters), which is G</span></span>
<span></span>
<span><span class="va">MD</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">ng</span><span class="op">)</span>   <span class="co"># maximum number of persons in a group</span></span>
<span><span class="va">NP</span> <span class="op">&lt;-</span> <span class="fl">2</span>         <span class="co"># number of covariance parameters theta</span></span>
<span></span>
<span><span class="co">#* list of design matrix for covariance matrix</span></span>
<span><span class="co">#  In the case of the random intercept model, the covariance structure is</span></span>
<span><span class="co">#  tau^2 * J + sigma^2 * I, where J is a matrix of ones and I is the</span></span>
<span><span class="co">#  identity matrix</span></span>
<span><span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">G</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">gg</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">G</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">Ngg</span> <span class="op">&lt;-</span> <span class="va">ng</span><span class="op">[</span><span class="va">gg</span><span class="op">]</span></span>
<span>    <span class="va">Z</span><span class="op">[[</span><span class="va">gg</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span> <span class="op">)</span></span>
<span>    <span class="va">Z</span><span class="op">[[</span><span class="va">gg</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span> <span class="fl">1</span>, nrow<span class="op">=</span><span class="va">Ngg</span>, ncol<span class="op">=</span><span class="va">Ngg</span> <span class="op">)</span>  <span class="co"># level 2 variance</span></span>
<span>    <span class="va">Z</span><span class="op">[[</span><span class="va">gg</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">Ngg</span><span class="op">)</span>            <span class="co"># level 1 variance</span></span>
<span><span class="op">}</span></span>
<span><span class="va">Z_list</span> <span class="op">&lt;-</span> <span class="va">Z</span></span>
<span><span class="co">#* parameter list containing the powers of parameters</span></span>
<span><span class="va">Z_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span> <span class="fl">0</span>, dim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">G</span>,<span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="va">Z_index</span><span class="op">[</span> <span class="fl">1</span><span class="op">:</span><span class="va">G</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Z_index</span><span class="op">[</span> <span class="fl">1</span><span class="op">:</span><span class="va">G</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="co">#** starting values and parameter names</span></span>
<span><span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="fl">1</span>, <span class="fl">0</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">beta</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"int"</span>, <span class="st">"x"</span><span class="op">)</span></span>
<span><span class="va">theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="fl">.05</span>, <span class="fl">1</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"tau2"</span>, <span class="st">"sig2"</span> <span class="op">)</span></span>
<span></span>
<span><span class="co">#** create dataset for lme4 for comparison</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">y</span>, x<span class="op">=</span><span class="va">x</span>, id<span class="op">=</span><span class="va">id</span> <span class="op">)</span></span>
<span></span>
<span><span class="co">#--------------------------------------------------------------</span></span>
<span><span class="co"># Model 1: Maximum likelihood estimation</span></span>
<span><span class="co">#--------------------------------------------------------------</span></span>
<span></span>
<span><span class="co">#** mlnormal function</span></span>
<span><span class="va">mod1a</span> <span class="op">&lt;-</span> <span class="fu">LAM</span><span class="fu">::</span><span class="fu">mlnormal</span><span class="op">(</span> y<span class="op">=</span><span class="va">y</span>, X<span class="op">=</span><span class="va">X</span>, id<span class="op">=</span><span class="va">id</span>, Z_list<span class="op">=</span><span class="va">Z_list</span>, Z_index<span class="op">=</span><span class="va">Z_index</span>,</span>
<span>            beta<span class="op">=</span><span class="va">beta</span>, theta<span class="op">=</span><span class="va">theta</span>, method<span class="op">=</span><span class="st">"ML"</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod1a</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># lme4::lmer function</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/" class="external-link">lme4</a></span><span class="op">)</span></span>
<span><span class="va">mod1b</span> <span class="op">&lt;-</span> <span class="fu">lme4</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer</a></span><span class="op">(</span> <span class="va">y</span> <span class="op">~</span> <span class="va">x</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">id</span> <span class="op">)</span>, data<span class="op">=</span><span class="va">dat</span>, REML<span class="op">=</span><span class="cn">FALSE</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod1b</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--------------------------------------------------------------</span></span>
<span><span class="co"># Model 2: Restricted maximum likelihood estimation</span></span>
<span><span class="co">#--------------------------------------------------------------</span></span>
<span></span>
<span><span class="co">#** mlnormal function</span></span>
<span><span class="va">mod2a</span> <span class="op">&lt;-</span> <span class="fu">LAM</span><span class="fu">::</span><span class="fu">mlnormal</span><span class="op">(</span> y<span class="op">=</span><span class="va">y</span>, X<span class="op">=</span><span class="va">X</span>, id<span class="op">=</span><span class="va">id</span>, Z_list<span class="op">=</span><span class="va">Z_list</span>, Z_index<span class="op">=</span><span class="va">Z_index</span>,</span>
<span>            beta<span class="op">=</span><span class="va">beta</span>, theta<span class="op">=</span><span class="va">theta</span>, method<span class="op">=</span><span class="st">"REML"</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod2a</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># lme4::lmer function</span></span>
<span><span class="va">mod2b</span> <span class="op">&lt;-</span> <span class="fu">lme4</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer</a></span><span class="op">(</span> <span class="va">y</span> <span class="op">~</span> <span class="va">x</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">id</span> <span class="op">)</span>, data<span class="op">=</span><span class="va">dat</span>, REML<span class="op">=</span><span class="cn">TRUE</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod2b</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--------------------------------------------------------------</span></span>
<span><span class="co"># Model 3: Estimation of standard deviation instead of variances</span></span>
<span><span class="co">#--------------------------------------------------------------</span></span>
<span></span>
<span><span class="co"># The model is now parametrized in standard deviations</span></span>
<span><span class="co"># Variances are then modeled as tau^2 and sigma^2, respectively.</span></span>
<span><span class="va">Z_index2</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">*</span><span class="va">Z_index</span>       <span class="co"># change loading matrix</span></span>
<span></span>
<span><span class="co"># estimate model</span></span>
<span><span class="va">mod3</span> <span class="op">&lt;-</span> <span class="fu">LAM</span><span class="fu">::</span><span class="fu">mlnormal</span><span class="op">(</span> y<span class="op">=</span><span class="va">y</span>, X<span class="op">=</span><span class="va">X</span>, id<span class="op">=</span><span class="va">id</span>, Z_list<span class="op">=</span><span class="va">Z_list</span>, Z_index<span class="op">=</span><span class="va">Z_index2</span>,</span>
<span>            beta<span class="op">=</span><span class="va">beta</span>, theta<span class="op">=</span><span class="va">theta</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod3</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--------------------------------------------------------------</span></span>
<span><span class="co"># Model 4: Maximum posterior estimation</span></span>
<span><span class="co">#--------------------------------------------------------------</span></span>
<span></span>
<span><span class="co"># specify prior distributions for parameters</span></span>
<span><span class="va">prior</span> <span class="op">&lt;-</span> <span class="st">"</span></span>
<span><span class="st">    tau2 ~ dgamma(NA, 2, .5 )</span></span>
<span><span class="st">    sig2 ~ dinvgamma(NA, .1, .1 )</span></span>
<span><span class="st">    x ~ dnorm( NA, .2, 1000 )</span></span>
<span><span class="st">    "</span></span>
<span></span>
<span><span class="co"># estimate model in mlnormal</span></span>
<span><span class="va">mod4</span> <span class="op">&lt;-</span> <span class="fu">LAM</span><span class="fu">::</span><span class="fu">mlnormal</span><span class="op">(</span> y<span class="op">=</span><span class="va">y</span>, X<span class="op">=</span><span class="va">X</span>, id<span class="op">=</span><span class="va">id</span>, Z_list<span class="op">=</span><span class="va">Z_list</span>, Z_index<span class="op">=</span><span class="va">Z_index</span>,</span>
<span>            beta<span class="op">=</span><span class="va">beta</span>, theta<span class="op">=</span><span class="va">theta</span>, method<span class="op">=</span><span class="st">"REML"</span>, prior<span class="op">=</span><span class="va">prior</span>, vcov<span class="op">=</span><span class="cn">FALSE</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod4</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--------------------------------------------------------------</span></span>
<span><span class="co"># Model 5: Estimation with regularization on beta and theta parameters</span></span>
<span><span class="co">#--------------------------------------------------------------</span></span>
<span></span>
<span><span class="co">#*** penalty on theta parameter</span></span>
<span><span class="va">lambda_theta</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">weights_theta</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">+</span> <span class="fl">0</span> <span class="op">*</span> <span class="va">theta</span></span>
<span><span class="co">#*** penalty on beta parameter</span></span>
<span><span class="va">lambda_beta</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span><span class="va">weights_beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="fl">0</span>, <span class="fl">1.8</span> <span class="op">)</span></span>
<span></span>
<span><span class="co"># estimate model</span></span>
<span><span class="va">mod5</span> <span class="op">&lt;-</span> <span class="fu">LAM</span><span class="fu">::</span><span class="fu">mlnormal</span><span class="op">(</span> y<span class="op">=</span><span class="va">y</span>, X<span class="op">=</span><span class="va">X</span>, id<span class="op">=</span><span class="va">id</span>, Z_list<span class="op">=</span><span class="va">Z_list</span>, Z_index<span class="op">=</span><span class="va">Z_index</span>,</span>
<span>            beta<span class="op">=</span><span class="va">beta</span>, theta<span class="op">=</span><span class="va">theta</span>, method<span class="op">=</span><span class="st">"ML"</span>, maxit<span class="op">=</span><span class="va">maxit</span>,</span>
<span>            lambda_theta<span class="op">=</span><span class="va">lambda_theta</span>, weights_theta<span class="op">=</span><span class="va">weights_theta</span>,</span>
<span>            lambda_beta<span class="op">=</span><span class="va">lambda_beta</span>, weights_beta<span class="op">=</span><span class="va">weights_beta</span>  <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod5</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#############################################################################</span></span>
<span><span class="co"># EXAMPLE 2: Latent covariate model, two-level regression</span></span>
<span><span class="co">#############################################################################</span></span>
<span></span>
<span><span class="co"># Yb=beta_0 + beta_b*Xb + eb (between level) and</span></span>
<span><span class="co"># Yw=beta_w*Xw + ew (within level)</span></span>
<span></span>
<span><span class="co">#--------------------------------------------------------------</span></span>
<span><span class="co"># Simulate data from latent covariate model</span></span>
<span><span class="co">#--------------------------------------------------------------</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">865</span><span class="op">)</span></span>
<span><span class="co"># regression parameters</span></span>
<span><span class="va">beta_0</span> <span class="op">&lt;-</span> <span class="fl">1</span> ; <span class="va">beta_b</span> <span class="op">&lt;-</span> <span class="fl">.7</span> ; <span class="va">beta_w</span> <span class="op">&lt;-</span> <span class="fl">.3</span></span>
<span><span class="va">G</span> <span class="op">&lt;-</span> <span class="fl">200</span>      <span class="co"># number of groups</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">15</span>      <span class="co"># group size</span></span>
<span><span class="va">iccx</span> <span class="op">&lt;-</span> <span class="fl">.2</span>   <span class="co"># intra class correlation x</span></span>
<span><span class="va">iccy</span> <span class="op">&lt;-</span> <span class="fl">.35</span>  <span class="co"># (conditional) intra class correlation y</span></span>
<span><span class="co"># simulate latent variables</span></span>
<span><span class="va">xb</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">G</span>, sd<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span> <span class="va">iccx</span> <span class="op">)</span> <span class="op">)</span></span>
<span><span class="va">yb</span> <span class="op">&lt;-</span> <span class="va">beta_0</span> <span class="op">+</span> <span class="va">beta_b</span> <span class="op">*</span> <span class="va">xb</span> <span class="op">+</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">G</span>, sd<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span> <span class="va">iccy</span> <span class="op">)</span> <span class="op">)</span></span>
<span><span class="va">xw</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">G</span><span class="op">*</span><span class="va">n</span>, sd<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span> <span class="fl">1</span><span class="op">-</span><span class="va">iccx</span> <span class="op">)</span> <span class="op">)</span></span>
<span><span class="va">yw</span> <span class="op">&lt;-</span> <span class="va">beta_w</span> <span class="op">*</span> <span class="va">xw</span> <span class="op">+</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">G</span><span class="op">*</span><span class="va">n</span>, sd<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span> <span class="fl">1</span><span class="op">-</span><span class="va">iccy</span> <span class="op">)</span> <span class="op">)</span></span>
<span><span class="va">group</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span> <span class="fl">1</span><span class="op">:</span><span class="va">G</span>, each<span class="op">=</span><span class="va">n</span> <span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">xw</span> <span class="op">+</span> <span class="va">xb</span><span class="op">[</span> <span class="va">group</span> <span class="op">]</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">yw</span> <span class="op">+</span> <span class="va">yb</span><span class="op">[</span> <span class="va">group</span> <span class="op">]</span></span>
<span><span class="co"># test results on true data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span> <span class="va">yb</span> <span class="op">~</span> <span class="va">xb</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span> <span class="va">yw</span> <span class="op">~</span> <span class="va">xw</span> <span class="op">)</span></span>
<span></span>
<span><span class="co"># create vector of outcomes in the form</span></span>
<span><span class="co"># ( y_11, x_11, y_21, x_21, ... )</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span> <span class="va">y</span>, <span class="va">x</span> <span class="op">)</span></span>
<span><span class="va">dat</span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">)</span>    <span class="co"># outcome vector</span></span>
<span><span class="va">ny</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span> <span class="fl">0</span>, nrow<span class="op">=</span><span class="va">ny</span>, ncol<span class="op">=</span><span class="fl">2</span> <span class="op">)</span></span>
<span><span class="va">X</span><span class="op">[</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">ny</span>,<span class="fl">2</span><span class="op">)</span>, <span class="fl">1</span> <span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span>   <span class="co"># design vector for mean y</span></span>
<span><span class="va">X</span><span class="op">[</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">2</span>,<span class="va">ny</span>,<span class="fl">2</span><span class="op">)</span>, <span class="fl">2</span> <span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span>   <span class="co"># design vector for mean x</span></span>
<span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span> <span class="va">group</span>, each<span class="op">=</span><span class="fl">2</span> <span class="op">)</span></span>
<span></span>
<span><span class="co">#--------------------------------------------------------------</span></span>
<span><span class="co"># Model 1: Linear regression ignoring multilevel structure</span></span>
<span><span class="co">#--------------------------------------------------------------</span></span>
<span></span>
<span><span class="co"># y=beta_0 + beta_t *x + e</span></span>
<span><span class="co"># Var(y)=beta_t^2 * var_x + var_e</span></span>
<span><span class="co"># Cov(y,x)=beta_t * var_x</span></span>
<span><span class="co"># Var(x)=var_x</span></span>
<span></span>
<span><span class="co">#** initial parameter values</span></span>
<span><span class="va">theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">.5</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="st">"beta_t"</span>, <span class="st">"var_x"</span>, <span class="st">"var_e"</span><span class="op">)</span></span>
<span><span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">beta</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mu_y"</span>,<span class="st">"mu_x"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The unit i is a cluster in this example.</span></span>
<span></span>
<span><span class="co">#--- define design matrices | list Z_list</span></span>
<span><span class="va">Hlist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>, <span class="fl">2</span>, <span class="fl">2</span> <span class="op">)</span>, <span class="co"># var(y)</span></span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>, <span class="fl">2</span>, <span class="fl">2</span> <span class="op">)</span>, <span class="co"># var(y) (two terms)</span></span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span>, <span class="fl">2</span>, <span class="fl">2</span> <span class="op">)</span>, <span class="co"># cov(x,y)</span></span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, <span class="fl">2</span>, <span class="fl">2</span> <span class="op">)</span> <span class="op">)</span> <span class="co"># var(x)</span></span>
<span></span>
<span><span class="va">U0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span> <span class="fl">0</span>, nrow<span class="op">=</span><span class="fl">2</span><span class="op">*</span><span class="va">n</span>,ncol<span class="op">=</span><span class="fl">2</span><span class="op">*</span><span class="va">n</span> <span class="op">)</span></span>
<span><span class="va">Ulist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span> <span class="va">U0</span>, <span class="va">U0</span>, <span class="va">U0</span>, <span class="va">U0</span> <span class="op">)</span></span>
<span><span class="va">M</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">Hlist</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">mm</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">M</span><span class="op">)</span><span class="op">{</span>    <span class="co"># mm &lt;- 1</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">nn</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span><span class="op">{</span>     <span class="co"># nn &lt;- 0</span></span>
<span>        <span class="va">Ulist</span><span class="op">[[</span> <span class="va">mm</span> <span class="op">]</span><span class="op">]</span><span class="op">[</span> <span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="va">nn</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="va">nn</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span> <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Hlist</span><span class="op">[[</span> <span class="va">mm</span> <span class="op">]</span><span class="op">]</span></span>
<span>    <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="va">Z_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">G</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">gg</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">G</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">Z_list</span><span class="op">[[</span><span class="va">gg</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Ulist</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#--- define index vectors</span></span>
<span><span class="va">Z_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span> <span class="fl">0</span>, dim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">G</span>, <span class="fl">4</span>, <span class="fl">3</span> <span class="op">)</span> <span class="op">)</span></span>
<span><span class="va">K0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span> <span class="fl">0</span>, nrow<span class="op">=</span><span class="fl">4</span>, ncol<span class="op">=</span><span class="fl">3</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">K0</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span></span>
<span><span class="co"># Var(y)=beta_t^2 * var_x + var_e  (matrices withn indices 1 and 2)</span></span>
<span><span class="va">K0</span><span class="op">[</span> <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"beta_t"</span>,<span class="st">"var_x"</span><span class="op">)</span> <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span>  <span class="co"># beta_t^2 * var_x</span></span>
<span><span class="va">K0</span><span class="op">[</span> <span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"var_e"</span><span class="op">)</span> <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>  <span class="co"># var_e</span></span>
<span><span class="co"># Cov(y,x)=beta_t * var_x</span></span>
<span><span class="va">K0</span><span class="op">[</span> <span class="fl">3</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"beta_t"</span>,<span class="st">"var_x"</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="co"># Var(x)=var_x</span></span>
<span><span class="va">K0</span><span class="op">[</span> <span class="fl">4</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"var_x"</span><span class="op">)</span> <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">gg</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">G</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">Z_index</span><span class="op">[</span><span class="va">gg</span>,,<span class="op">]</span> <span class="op">&lt;-</span> <span class="va">K0</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#*** estimate model with mlnormal</span></span>
<span><span class="va">mod1a</span> <span class="op">&lt;-</span> <span class="fu">LAM</span><span class="fu">::</span><span class="fu">mlnormal</span><span class="op">(</span> y<span class="op">=</span><span class="va">Y</span>, X<span class="op">=</span><span class="va">X</span>, id<span class="op">=</span><span class="va">id</span>, Z_list<span class="op">=</span><span class="va">Z_list</span>, Z_index<span class="op">=</span><span class="va">Z_index</span>,</span>
<span>            beta<span class="op">=</span><span class="va">beta</span>, theta<span class="op">=</span><span class="va">theta</span>, method<span class="op">=</span><span class="st">"REML"</span>, vcov<span class="op">=</span><span class="cn">FALSE</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod1a</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#*** estimate linear regression with stats::lm</span></span>
<span><span class="va">mod1b</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span> <span class="va">y</span> <span class="op">~</span> <span class="va">x</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod1b</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--------------------------------------------------------------</span></span>
<span><span class="co"># Model 2: Latent covariate model</span></span>
<span><span class="co">#--------------------------------------------------------------</span></span>
<span></span>
<span><span class="co">#** initial parameters</span></span>
<span><span class="va">theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="fl">0.12</span>, <span class="fl">.6</span>, <span class="fl">.5</span>, <span class="fl">0</span>, <span class="fl">.2</span>, <span class="fl">.2</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="st">"beta_w"</span>, <span class="st">"var_xw"</span>, <span class="st">"var_ew"</span>,</span>
<span>                <span class="st">"beta_b"</span>, <span class="st">"var_xb"</span>, <span class="st">"var_eb"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- define design matrices | list Z_list</span></span>
<span><span class="va">Hlist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>, <span class="fl">2</span>, <span class="fl">2</span> <span class="op">)</span>, <span class="co"># var(y)</span></span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>, <span class="fl">2</span>, <span class="fl">2</span> <span class="op">)</span>, <span class="co"># var(y) (two terms)</span></span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span>, <span class="fl">2</span>, <span class="fl">2</span> <span class="op">)</span>, <span class="co"># cov(x,y)</span></span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, <span class="fl">2</span>, <span class="fl">2</span> <span class="op">)</span> <span class="op">)</span> <span class="co"># var(x)</span></span>
<span><span class="va">U0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span> <span class="fl">0</span>, nrow<span class="op">=</span><span class="fl">2</span><span class="op">*</span><span class="va">n</span>,ncol<span class="op">=</span><span class="fl">2</span><span class="op">*</span><span class="va">n</span> <span class="op">)</span></span>
<span><span class="va">Ulist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span> <span class="va">U0</span>, <span class="va">U0</span>, <span class="va">U0</span>, <span class="va">U0</span>,  <span class="co"># within structure</span></span>
<span>               <span class="va">U0</span>, <span class="va">U0</span>, <span class="va">U0</span>, <span class="va">U0</span>  <span class="op">)</span>  <span class="co"># between structure</span></span>
<span><span class="va">M</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">Hlist</span><span class="op">)</span></span>
<span><span class="co">#*** within structure</span></span>
<span><span class="va">design_within</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>  <span class="co"># design matrix within structure</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">mm</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">M</span><span class="op">)</span><span class="op">{</span>    <span class="co"># mm &lt;- 1</span></span>
<span>    <span class="va">Ulist</span><span class="op">[[</span> <span class="va">mm</span> <span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/kronecker.html" class="external-link">kronecker</a></span><span class="op">(</span> <span class="va">design_within</span>, <span class="va">Hlist</span><span class="op">[[</span><span class="va">mm</span><span class="op">]</span><span class="op">]</span> <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#*** between structure</span></span>
<span><span class="va">design_between</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1</span>, nrow<span class="op">=</span><span class="va">n</span>, ncol<span class="op">=</span><span class="va">n</span><span class="op">)</span></span>
<span>      <span class="co"># matrix of ones corresponding to group size</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">mm</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">M</span><span class="op">)</span><span class="op">{</span>    <span class="co"># mm &lt;- 1</span></span>
<span>    <span class="va">Ulist</span><span class="op">[[</span> <span class="va">mm</span> <span class="op">+</span> <span class="va">M</span> <span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/kronecker.html" class="external-link">kronecker</a></span><span class="op">(</span> <span class="va">design_between</span>, <span class="va">Hlist</span><span class="op">[[</span> <span class="va">mm</span> <span class="op">]</span><span class="op">]</span> <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">Z_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">G</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">gg</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">G</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">Z_list</span><span class="op">[[</span><span class="va">gg</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Ulist</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#--- define index vectors Z_index</span></span>
<span><span class="va">Z_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span> <span class="fl">0</span>, dim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">G</span>, <span class="fl">8</span>, <span class="fl">6</span> <span class="op">)</span> <span class="op">)</span></span>
<span><span class="va">K0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span> <span class="fl">0</span>, nrow<span class="op">=</span><span class="fl">8</span>, ncol<span class="op">=</span><span class="fl">6</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">K0</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span></span>
<span><span class="co"># Var(y)=beta^2 * var_x + var_e  (matrices withn indices 1 and 2)</span></span>
<span><span class="va">K0</span><span class="op">[</span> <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"beta_w"</span>,<span class="st">"var_xw"</span><span class="op">)</span> <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span>  <span class="co"># beta_t^2 * var_x</span></span>
<span><span class="va">K0</span><span class="op">[</span> <span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"var_ew"</span><span class="op">)</span> <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>  <span class="co"># var_e</span></span>
<span><span class="va">K0</span><span class="op">[</span> <span class="fl">5</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"beta_b"</span>,<span class="st">"var_xb"</span><span class="op">)</span> <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span>  <span class="co"># beta_t^2 * var_x</span></span>
<span><span class="va">K0</span><span class="op">[</span> <span class="fl">6</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"var_eb"</span><span class="op">)</span> <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>  <span class="co"># var_e</span></span>
<span><span class="co"># Cov(y,x)=beta * var_x</span></span>
<span><span class="va">K0</span><span class="op">[</span> <span class="fl">3</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"beta_w"</span>,<span class="st">"var_xw"</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">K0</span><span class="op">[</span> <span class="fl">7</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"beta_b"</span>,<span class="st">"var_xb"</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="co"># Var(x)=var_x</span></span>
<span><span class="va">K0</span><span class="op">[</span> <span class="fl">4</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"var_xw"</span><span class="op">)</span> <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">K0</span><span class="op">[</span> <span class="fl">8</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"var_xb"</span><span class="op">)</span> <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">gg</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">G</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">Z_index</span><span class="op">[</span><span class="va">gg</span>,,<span class="op">]</span> <span class="op">&lt;-</span> <span class="va">K0</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#--- estimate model with mlnormal</span></span>
<span><span class="va">mod2a</span> <span class="op">&lt;-</span> <span class="fu">LAM</span><span class="fu">::</span><span class="fu">mlnormal</span><span class="op">(</span> y<span class="op">=</span><span class="va">Y</span>, X<span class="op">=</span><span class="va">X</span>, id<span class="op">=</span><span class="va">id</span>, Z_list<span class="op">=</span><span class="va">Z_list</span>, Z_index<span class="op">=</span><span class="va">Z_index</span>,</span>
<span>            beta<span class="op">=</span><span class="va">beta</span>, theta<span class="op">=</span><span class="va">theta</span>, method<span class="op">=</span><span class="st">"ML"</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod2a</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#############################################################################</span></span>
<span><span class="co"># EXAMPLE 3: Simple linear regression, single level</span></span>
<span><span class="co">#############################################################################</span></span>
<span></span>
<span><span class="co">#--------------------------------------------------------------</span></span>
<span><span class="co"># Simulate data</span></span>
<span><span class="co">#--------------------------------------------------------------</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">875</span><span class="op">)</span></span>
<span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">300</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span> <span class="va">N</span>, sd<span class="op">=</span><span class="fl">1.3</span> <span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fl">.4</span> <span class="op">+</span> <span class="fl">.7</span> <span class="op">*</span> <span class="va">x</span> <span class="op">+</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span> <span class="va">N</span>, sd<span class="op">=</span><span class="fl">.5</span> <span class="op">)</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span> <span class="va">x</span>, <span class="va">y</span> <span class="op">)</span></span>
<span></span>
<span><span class="co">#--------------------------------------------------------------</span></span>
<span><span class="co"># Model 1: Linear regression modelled with residual covariance structure</span></span>
<span><span class="co">#--------------------------------------------------------------</span></span>
<span></span>
<span><span class="co"># matrix of predictros</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span> <span class="fl">1</span>, <span class="va">x</span> <span class="op">)</span></span>
<span><span class="co"># list with design matrices</span></span>
<span><span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">nn</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">Z</span><span class="op">[[</span><span class="va">nn</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span> <span class="fl">1</span> <span class="op">)</span></span>
<span>    <span class="va">Z</span><span class="op">[[</span><span class="va">nn</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span> <span class="fl">1</span>, nrow<span class="op">=</span><span class="fl">1</span>, ncol<span class="op">=</span><span class="fl">1</span> <span class="op">)</span>  <span class="co"># residual variance</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#* loading matrix</span></span>
<span><span class="va">Z_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span> <span class="fl">0</span>, dim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">N</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="va">Z_index</span><span class="op">[</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">2</span>  <span class="co"># parametrize residual standard deviation</span></span>
<span><span class="co">#** starting values and parameter names</span></span>
<span><span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="fl">0</span>, <span class="fl">0</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">beta</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"int"</span>, <span class="st">"x"</span><span class="op">)</span></span>
<span><span class="va">theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sig2"</span> <span class="op">)</span></span>
<span><span class="co"># id vector</span></span>
<span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span></span>
<span></span>
<span><span class="co">#** mlnormal function</span></span>
<span><span class="va">mod1a</span> <span class="op">&lt;-</span> <span class="fu">LAM</span><span class="fu">::</span><span class="fu">mlnormal</span><span class="op">(</span> y<span class="op">=</span><span class="va">y</span>, X<span class="op">=</span><span class="va">X</span>, id<span class="op">=</span><span class="va">id</span>, Z_list<span class="op">=</span><span class="va">Z</span>, Z_index<span class="op">=</span><span class="va">Z_index</span>,</span>
<span>            beta<span class="op">=</span><span class="va">beta</span>, theta<span class="op">=</span><span class="va">theta</span>, method<span class="op">=</span><span class="st">"ML"</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod1a</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># estimate linear regression with stats::lm</span></span>
<span><span class="va">mod1b</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span> <span class="va">y</span> <span class="op">~</span> <span class="va">x</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod1b</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--------------------------------------------------------------</span></span>
<span><span class="co"># Model 2: Linear regression modelled with bivariate covariance structure</span></span>
<span><span class="co">#--------------------------------------------------------------</span></span>
<span></span>
<span><span class="co">#** define design matrix referring to mean structure</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span> <span class="fl">0</span>, nrow<span class="op">=</span><span class="fl">2</span><span class="op">*</span><span class="va">N</span>, ncol<span class="op">=</span><span class="fl">2</span> <span class="op">)</span></span>
<span><span class="va">X</span><span class="op">[</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">*</span><span class="va">N</span>,<span class="fl">2</span><span class="op">)</span>, <span class="fl">1</span> <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">X</span><span class="op">[</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">*</span><span class="va">N</span>,<span class="fl">2</span><span class="op">)</span>, <span class="fl">2</span> <span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="co">#** create outcome vector</span></span>
<span><span class="va">y1</span> <span class="op">&lt;-</span> <span class="va">dat</span><span class="op">[</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span>, each<span class="op">=</span><span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">N</span> <span class="op">)</span> <span class="op">)</span> <span class="op">]</span></span>
<span><span class="co">#** list with design matrices</span></span>
<span><span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span></span>
<span><span class="va">Z0</span> <span class="op">&lt;-</span> <span class="fl">0</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span> <span class="fl">0</span>, nrow<span class="op">=</span><span class="fl">2</span>,ncol<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">ZXY</span> <span class="op">&lt;-</span> <span class="va">ZY</span> <span class="op">&lt;-</span> <span class="va">ZX</span> <span class="op">&lt;-</span> <span class="va">Z0</span></span>
<span><span class="co"># design matrix Var(X)</span></span>
<span><span class="va">ZX</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="co"># design matrix Var(Y)</span></span>
<span><span class="va">ZY</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="co"># design matrix covariance</span></span>
<span><span class="va">ZXY</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">ZXY</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="co"># Var(X)=sigx^2</span></span>
<span><span class="co"># Cov(X,Y)=beta * sigx^2</span></span>
<span><span class="co"># Var(Y)=beta^2 * sigx^2 + sige^2</span></span>
<span><span class="va">Z_list0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span> <span class="va">ZY</span>, <span class="va">ZY</span>, <span class="va">ZXY</span>, <span class="va">ZX</span> <span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">nn</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">Z</span><span class="op">[[</span><span class="va">nn</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Z_list0</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#* parameter list containing the powers of parameters</span></span>
<span><span class="va">theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0.3</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sigx"</span>, <span class="st">"beta"</span>, <span class="st">"sige"</span> <span class="op">)</span></span>
<span><span class="va">Z_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span> <span class="fl">0</span>, dim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">N</span>,<span class="fl">4</span>,<span class="fl">3</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">nn</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co"># Var(X)</span></span>
<span>    <span class="va">Z_index</span><span class="op">[</span><span class="va">nn</span>, <span class="fl">4</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="co"># Cov(X,Y)</span></span>
<span>    <span class="va">Z_index</span><span class="op">[</span><span class="va">nn</span>, <span class="fl">3</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="co"># Var(Y)</span></span>
<span>    <span class="va">Z_index</span><span class="op">[</span><span class="va">nn</span>,<span class="fl">1</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span>,<span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="va">Z_index</span><span class="op">[</span><span class="va">nn</span>,<span class="fl">2</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#** starting values and parameter names</span></span>
<span><span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="fl">0</span>, <span class="fl">0</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">beta</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Mx"</span>, <span class="st">"My"</span><span class="op">)</span></span>
<span><span class="co"># id vector</span></span>
<span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span>, each<span class="op">=</span><span class="fl">2</span> <span class="op">)</span></span>
<span></span>
<span><span class="co">#** mlnormal function</span></span>
<span><span class="va">mod2a</span> <span class="op">&lt;-</span> <span class="fu">LAM</span><span class="fu">::</span><span class="fu">mlnormal</span><span class="op">(</span> y<span class="op">=</span><span class="va">y1</span>, X<span class="op">=</span><span class="va">X</span>, id<span class="op">=</span><span class="va">id</span>, Z_list<span class="op">=</span><span class="va">Z</span>, Z_index<span class="op">=</span><span class="va">Z_index</span>,</span>
<span>            beta<span class="op">=</span><span class="va">beta</span>, theta<span class="op">=</span><span class="va">theta</span>, method<span class="op">=</span><span class="st">"ML"</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod2a</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--------------------------------------------------------------</span></span>
<span><span class="co"># Model 3: Bivariate normal distribution in (sigma_X, sigma_Y, sigma_XY) parameters</span></span>
<span><span class="co">#--------------------------------------------------------------</span></span>
<span></span>
<span><span class="co"># list with design matrices</span></span>
<span><span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span></span>
<span><span class="va">Z0</span> <span class="op">&lt;-</span> <span class="fl">0</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span> <span class="fl">0</span>, nrow<span class="op">=</span><span class="fl">2</span>,ncol<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">ZXY</span> <span class="op">&lt;-</span> <span class="va">ZY</span> <span class="op">&lt;-</span> <span class="va">ZX</span> <span class="op">&lt;-</span> <span class="va">Z0</span></span>
<span><span class="co"># design matrix Var(X)</span></span>
<span><span class="va">ZX</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="co"># design matrix Var(Y)</span></span>
<span><span class="va">ZY</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="co"># design matrix covariance</span></span>
<span><span class="va">ZXY</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">ZXY</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">Z_list0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span> <span class="va">ZX</span>, <span class="va">ZY</span>, <span class="va">ZXY</span>  <span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">nn</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">Z</span><span class="op">[[</span><span class="va">nn</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Z_list0</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#* parameter list</span></span>
<span><span class="va">theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">.3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sigx"</span>, <span class="st">"sigy"</span>, <span class="st">"sigxy"</span> <span class="op">)</span></span>
<span><span class="va">Z_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span> <span class="fl">0</span>, dim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">N</span>,<span class="fl">3</span>,<span class="fl">3</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">nn</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co"># Var(X)</span></span>
<span>    <span class="va">Z_index</span><span class="op">[</span><span class="va">nn</span>, <span class="fl">1</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="co"># Var(Y)</span></span>
<span>    <span class="va">Z_index</span><span class="op">[</span><span class="va">nn</span>, <span class="fl">2</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">2</span>,<span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="co"># Cov(X,Y)</span></span>
<span>    <span class="va">Z_index</span><span class="op">[</span><span class="va">nn</span>, <span class="fl">3</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#** starting values and parameter names</span></span>
<span><span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="fl">0</span>, <span class="fl">0</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">beta</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Mx"</span>, <span class="st">"My"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#** mlnormal function</span></span>
<span><span class="va">mod3a</span> <span class="op">&lt;-</span> <span class="fu">LAM</span><span class="fu">::</span><span class="fu">mlnormal</span><span class="op">(</span> y<span class="op">=</span><span class="va">y1</span>, X<span class="op">=</span><span class="va">X</span>, id<span class="op">=</span><span class="va">id</span>, Z_list<span class="op">=</span><span class="va">Z</span>, Z_index<span class="op">=</span><span class="va">Z_index</span>,</span>
<span>            beta<span class="op">=</span><span class="va">beta</span>, theta<span class="op">=</span><span class="va">theta</span>, method<span class="op">=</span><span class="st">"ML"</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod3a</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--------------------------------------------------------------</span></span>
<span><span class="co"># Model 4: Bivariate normal distribution in parameters of Cholesky decomposition</span></span>
<span><span class="co">#--------------------------------------------------------------</span></span>
<span></span>
<span><span class="co"># list with design matrices</span></span>
<span><span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span></span>
<span><span class="va">Z0</span> <span class="op">&lt;-</span> <span class="fl">0</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span> <span class="fl">0</span>, nrow<span class="op">=</span><span class="fl">2</span>,ncol<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">ZXY</span> <span class="op">&lt;-</span> <span class="va">ZY</span> <span class="op">&lt;-</span> <span class="va">ZX</span> <span class="op">&lt;-</span> <span class="va">Z0</span></span>
<span><span class="co"># design matrix Var(X)</span></span>
<span><span class="va">ZX</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="co"># design matrix Var(Y)</span></span>
<span><span class="va">ZY</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="co"># design matrix covariance</span></span>
<span><span class="va">ZXY</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">ZXY</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">Z_list0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span> <span class="va">ZX</span>, <span class="va">ZXY</span>, <span class="va">ZY</span>, <span class="va">ZY</span>  <span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">nn</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">Z</span><span class="op">[[</span><span class="va">nn</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Z_list0</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#* parameter list containing the powers of parameters</span></span>
<span><span class="va">theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0.3</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"L11"</span>, <span class="st">"L21"</span>, <span class="st">"L22"</span> <span class="op">)</span></span>
<span><span class="va">Z_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span> <span class="fl">0</span>, dim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">N</span>,<span class="fl">4</span>,<span class="fl">3</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">nn</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">Z_index</span><span class="op">[</span><span class="va">nn</span>,<span class="fl">1</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="va">Z_index</span><span class="op">[</span><span class="va">nn</span>,<span class="fl">2</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="va">Z_index</span><span class="op">[</span><span class="va">nn</span>,<span class="fl">3</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">2</span>,<span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="va">Z_index</span><span class="op">[</span><span class="va">nn</span>,<span class="fl">4</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#** starting values and parameter names</span></span>
<span><span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="fl">0</span>, <span class="fl">0</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">beta</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Mx"</span>, <span class="st">"My"</span><span class="op">)</span></span>
<span><span class="co"># id vector</span></span>
<span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span>, each<span class="op">=</span><span class="fl">2</span> <span class="op">)</span></span>
<span><span class="co">#** mlnormal function</span></span>
<span><span class="va">mod4a</span> <span class="op">&lt;-</span> <span class="fu">LAM</span><span class="fu">::</span><span class="fu">mlnormal</span><span class="op">(</span> y<span class="op">=</span><span class="va">y1</span>, X<span class="op">=</span><span class="va">X</span>, id<span class="op">=</span><span class="va">id</span>, Z_list<span class="op">=</span><span class="va">Z</span>, Z_index<span class="op">=</span><span class="va">Z_index</span>,</span>
<span>            beta<span class="op">=</span><span class="va">beta</span>, theta<span class="op">=</span><span class="va">theta</span>, method<span class="op">=</span><span class="st">"ML"</span> <span class="op">)</span></span>
<span><span class="co"># parameter with lower diagonal entries of Cholesky matrix</span></span>
<span><span class="va">mod4a</span><span class="op">$</span><span class="va">theta</span></span>
<span><span class="co"># fill-in parameters for Cholesky matrix</span></span>
<span><span class="va">L</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">L</span><span class="op">[</span> <span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/lower.tri.html" class="external-link">upper.tri</a></span><span class="op">(</span><span class="va">L</span><span class="op">)</span> <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">mod4a</span><span class="op">$</span><span class="va">theta</span></span>
<span><span class="co">#** reconstruct covariance matrix</span></span>
<span><span class="va">L</span> </span>
<span><span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/cov.wt.html" class="external-link">cov.wt</a></span><span class="op">(</span><span class="va">dat</span>, method<span class="op">=</span><span class="st">"ML"</span><span class="op">)</span><span class="op">$</span><span class="va">cov</span></span>
<span><span class="op">}</span></span></code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Alexander Robitzsch.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer></div>

  


  

  </body></html>

